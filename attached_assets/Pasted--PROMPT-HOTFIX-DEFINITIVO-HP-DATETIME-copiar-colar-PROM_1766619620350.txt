üî• PROMPT ‚Äî HOTFIX DEFINITIVO HP DATETIME (copiar/colar)
PROMPT ‚Äî CORRE√á√ÉO DEFINITIVA DO ERRO
"can't compare offset-naive and offset-aware datetimes"
NO PIPELINE DE HP (OBRIGAT√ìRIO)

CONTEXTO
O agente processa relat√≥rios HP (PDF) diariamente.
Dos v√°rios HPs enviados, apenas 6 foram processados com sucesso.
Todos os demais falham com o erro:
"can't compare offset-naive and offset-aware datetimes".

Este erro √© CR√çTICO e BLOQUEIA o Data Lake.
Ele indica que o c√≥digo est√° comparando datetimes com timezone (aware)
com datetimes sem timezone (naive).

OBJETIVO
Eliminar COMPLETAMENTE esse erro do pipeline de HP, garantindo:
- padroniza√ß√£o absoluta de datas/horas
- nenhuma compara√ß√£o inv√°lida
- 100% dos HPs v√°lidos processados com status PROCESSED

---

# 1) REGRA ABSOLUTA DE TEMPO (N√ÉO NEGOCI√ÅVEL)

A aplica√ß√£o deve obedecer **UMA √öNICA REGRA**:

‚úÖ TODAS as vari√°veis datetime do backend devem ser:
- timezone-aware
- normalizadas em UTC

‚ùå √â PROIBIDO:
- comparar aware com naive
- misturar datetime com date em compara√ß√µes
- depender de timezone local do sistema

---

# 2) NORMALIZA√á√ÉO OBRIGAT√ìRIA (ONDE CORRIGIR)

## 2.1 No parser do HP (IMEDIATO)
Assim que `generated_at` for extra√≠do do PDF:

- Se vier sem timezone:


generated_at = generated_at.replace(tzinfo=timezone.utc)

- Se vier com timezone:


generated_at = generated_at.astimezone(timezone.utc)


Isso deve acontecer **antes de qualquer uso** da vari√°vel.

---

## 2.2 Regra REAL vs FORECAST (CORRE√á√ÉO FUNDAMENTAL)

‚ùå ERRO ATUAL (prov√°vel):


if target_date < generated_at:


‚úÖ REGRA CORRETA:


as_of_date = generated_at.date()

if target_date < as_of_date:
status = REAL
else:
status = FORECAST


üö´ NUNCA comparar DATE com DATETIME.

---

## 2.3 Deduplica√ß√£o e Ordena√ß√£o
Ao usar `(target_date, generated_at)` como chave:

- `target_date` ‚Üí DATE
- `generated_at` ‚Üí DATETIME (UTC aware)

Qualquer sort/order/filter deve ocorrer entre:
- DATETIME vs DATETIME
- DATE vs DATE

Nunca misturar.

---

## 2.4 Banco de Dados (obrigat√≥rio verificar)
Verificar e corrigir:

- Campos como:
  - uploaded_at
  - processed_at
  - generated_at
devem ser `TIMESTAMPTZ`.

Se houver `timestamp without time zone`:
- migrar para `TIMESTAMPTZ`
OU
- garantir que sempre gravam UTC-aware (n√£o recomendado, mas aceit√°vel se consistente).

---

# 3) PIPELINE DE STATUS (CORRE√á√ÉO DE ESTADO)

Corrigir a m√°quina de estados do upload HP:

Estados v√°lidos:
- UPLOADED
- PROCESSING
- PROCESSED
- FAILED

Regras:
- Se ao menos 1 linha for persistida ‚Üí PROCESSED
- FAILED somente se:
  - parsing falhou
  - zero linhas persistidas
  - erro n√£o recuper√°vel

‚ùå √â PROIBIDO:
- status FAILED coexistir com ‚ÄúConfian√ßa 100%‚Äù
- marcar FAILED ap√≥s persist√™ncia bem-sucedida

---

# 4) LOGS E DIAGN√ìSTICO (OBRIGAT√ìRIO)

Criar ou garantir logs estruturados por etapa:

Tabela (ou estrutura equivalente):
- report_extract_log
Campos:
- report_upload_id
- step (DETECT, PARSE_HEADER, PARSE_ROWS, NORMALIZE, UPSERT, FINALIZE)
- level (INFO / WARN / ERROR)
- message
- payload_json

Sempre registrar:
- tipo de datetime detectado (naive/aware)
- valor original
- valor normalizado

---

# 5) REPROCESSAMENTO EM MASSA (OBRIGAT√ìRIO)

Criar fun√ß√£o/endpoint:
- `reprocess_failed_hp_uploads()`

Fluxo:
1) Buscar todos HP com status FAILED
2) Reprocessar usando o parser corrigido
3) Atualizar status corretamente
4) Registrar tentativa e resultado

---

# 6) TESTE DE ACEITA√á√ÉO (N√ÉO NEGOCI√ÅVEL)

Usar os HPs reais j√° enviados (inclusive os que falharam).

Crit√©rios de aceite:
- Nenhum erro "offset-naive and offset-aware" ocorre
- Todos HPs v√°lidos terminam com status PROCESSED
- occupancy_snapshots preenchida
- occupancy_latest atualizado
- Tela de uploads reflete status correto
- Logs mostram NORMALIZA√á√ÉO DE DATETIME executada

Se qualquer HP v√°lido ainda falhar, o prompt N√ÉO est√° conclu√≠do.

---

# 7) ENTREGA OBRIGAT√ìRIA

- Commit com mensagem:
  "HOTFIX: normalize datetime to UTC-aware across HP pipeline"
- Documento curto no README ou replit.md:
  - causa raiz encontrada
  - solu√ß√£o aplicada
  - como validar

IMPORTANTE
N√£o criar workaround.
N√£o suprimir erro.
N√£o ignorar compara√ß√£o.
A corre√ß√£o deve ser estrutural e definitiva.